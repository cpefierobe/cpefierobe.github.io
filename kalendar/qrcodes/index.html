<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
  <title>Générateur A4 aléatoire</title>

  <style>
    body { font-family: sans-serif; padding:20px; }
    canvas { border:1px solid #aaa; margin-top:20px; }
  </style>
</head>

<body>
  <h2>Générateur A4 (aléatoire, sans chevauchement)</h2>

  <button onclick="generer()">Générer</button>
  <button onclick="saveComposition()">Enregistrer composition</button>
  <button onclick="saveFond()">Enregistrer fond numéroté</button>

<script>

  // A4 paysage en 300dpi : 3508 × 2480 px
  const A4_W = 3508;
  const A4_H = 2480;

  let imgs = [];
  let positions = [];
  let fond;
  let composition, fondNum;

  function preload() {
    for (let i = 1; i <= 25; i++) {
      imgs[i] = loadImage("tag" + i + ".png");
    }
    fond = loadImage("fond.jpg");
  }

  function setup() {
    createCanvas(700, 500); // aperçu réduit
    noLoop();
  }

  function generer() {
    arrangerImagesAleatoires();
    dessinerComposition();
    dessinerFond();
    image(composition, 0, 0, width, height);
  }

  // -------------------------------------------------------
  // Placement aléatoire sans chevauchement
  // -------------------------------------------------------

  function arrangerImagesAleatoires() {
    positions = [];
    let maxSize = min(A4_W, A4_H) / 6;  // taille visuelle des images

    for (let i = 1; i <= 25; i++) {
      let placed = false;
      let tries = 0;

      while (!placed && tries < 200) {
        tries++;

        let x = random(maxSize, A4_W - maxSize);
        let y = random(maxSize, A4_H - maxSize);

        // Ajuste l'image au format carré
        let ratio = maxSize / max(imgs[i].width, imgs[i].height);
        let w = imgs[i].width * ratio;
        let h = imgs[i].height * ratio;

        let newBox = { x, y, w, h };

        if (!isOverlapping(newBox, positions)) {
          positions[i] = newBox;
          placed = true;
        }
      }

      if (!placed) {
        console.log("Impossible de placer l'image " + i);
      }
    }
  }

  // Test de chevauchement
  function isOverlapping(box, others) {
    for (let j = 1; j < others.length; j++) {
      let o = others[j];
      if (!o) continue;

      if (abs(box.x - o.x) < (box.w + o.w) * 0.55 &&
          abs(box.y - o.y) < (box.h + o.h) * 0.55) {
        return true;
      }
    }
    return false;
  }

  // -------------------------------------------------------
  // Composition avec toutes les images
  // -------------------------------------------------------
  function dessinerComposition() {
    composition = createGraphics(A4_W, A4_H);
    composition.background(255);

    for (let i = 1; i <= 25; i++) {
      let p = positions[i];
      if (!p) continue;

      composition.imageMode(CENTER);
      composition.image(imgs[i], p.x, p.y, p.w, p.h);
    }
  }

  // -------------------------------------------------------
  // Fond + carrés numérotés (contour uniquement)
  // -------------------------------------------------------
  function dessinerFond() {
    fondNum = createGraphics(A4_W, A4_H);

    // Fond
    fondNum.image(fond, 0, 0, A4_W, A4_H);

    // Style des carrés
    fondNum.rectMode(CENTER);
    fondNum.textAlign(CENTER, CENTER);
    fondNum.textSize(100);
    fondNum.stroke(80);    // gris foncé
    fondNum.noFill();
    fondNum.strokeWeight(8);
    fondNum.fill(80);      // texte gris foncé

    for (let i = 1; i <= 25; i++) {
      let p = positions[i];
      if (!p) continue;

      let s = max(p.w, p.h) * 1.1;

      fondNum.noFill();
      fondNum.rect(p.x, p.y, s, s, 25);

      fondNum.fill(80);
      fondNum.text(i, p.x, p.y);
    }
  }

  // -------------------------------------------------------
  // Sauvegarde
  // -------------------------------------------------------
  function saveComposition() {
    if (composition) save(composition, "composition_A4_aleatoire.png");
  }

  function saveFond() {
    if (fondNum) save(fondNum, "fond_num_A4_aleatoire.png");
  }

</script>

</body>
</html>
