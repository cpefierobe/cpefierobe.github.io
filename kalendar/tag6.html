<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Gravité + Rebonds</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>

  <style>
    body { margin:0; padding:0; overflow:hidden; touch-action:none; }
    #ui {
      position:absolute; top:10px; left:10px; right:10px;
      display:flex; flex-direction:column; gap:10px;
      font-family:sans-serif; color:white;
      z-index:10;
    }
    #endMessage, #startMessage, #loseMessage {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 30px;
      font-weight: bold;
      text-shadow: 0 0 10px black;
      display: none;
    }
  </style>
</head>

<body>

<div id="ui">
    Masse planète :
    <input type="range" min="50" max="10000" value="1000" id="mass">
    <button id="startBtn">Los !</button>
    <button id="resetBtn">Erneut</button>
</div>

<div id="startMessage">Benutz die Gravitation!</div>
<div id="endMessage" style="text-align: center;">Bravo Morty! Die Kode für das Bild in meinem Brief ist ... Du wirst sie später brauchen!</div>
<div id="loseMessage">Verloren!</div>

<script>
let projectile, planet, target;
let launched = false;
let gameOver = false;

let G = 0.9;
let softening = 50;
let damping = 0.999;

function setup() {
  createCanvas(windowWidth, windowHeight);
  resetSim();

  document.getElementById("startBtn").onclick = () => {
    if (gameOver) return;
    launched = true;
    document.getElementById("startMessage").style.display = "none";
  };
  
  document.getElementById("resetBtn").onclick = resetSim;
}

function resetSim() {
  launched = false;
  gameOver = false;

  document.getElementById("endMessage").style.display = "none";
  document.getElementById("loseMessage").style.display = "none";
  document.getElementById("startMessage").style.display = "block";

  projectile = {
    pos: createVector(width*0.1, height*0.65),
    vel: createVector(4, -0.5),
    mass: 1,
    r: 10
  };

  planet = {
    pos: createVector(width*0.5, height*0.5),
    vel: createVector(0, 0),
    mass: parseFloat(document.getElementById("mass").value),
    r: map(parseFloat(document.getElementById("mass").value), 50, 10000, 20, 90)
  };

  target = createVector(width*0.85, height*0.25);
}

function draw() {
  background(10);

  if (gameOver) {  
    drawBodies();
    drawTarget();
    return;
  }

  if (!launched) {
    planet.mass = parseFloat(document.getElementById("mass").value);
    planet.r = map(planet.mass, 50, 10000, 20, 90);
  }

  drawTarget();

  if (launched) applyGravity();
  if (launched) updateBodies();

  // Vérifie si collision = défaite
  if (projectile.pos.dist(planet.pos) < projectile.r + planet.r) {
    launched = false;
    gameOver = true;
    document.getElementById("loseMessage").style.display = "block";
  }

  drawBodies();

  // Victoire ?
  if (!gameOver && launched && projectile.pos.dist(target) < 25) {
    launched = false;
    document.getElementById("endMessage").style.display = "block";
  }
}

function drawTarget() {
  stroke(0,255,0); strokeWeight(3); noFill();
  ellipse(target.x, target.y, 40);

  noStroke();
  fill(255);
  textAlign(CENTER, CENTER);
  textSize(20);
  text("Ziel", target.x, target.y - 35);
}

function applyGravity() {
  let dirP = p5.Vector.sub(planet.pos, projectile.pos);
  let distSq = dirP.magSq() + softening*softening;

  let force = (G * planet.mass * projectile.mass) / distSq;

  projectile.vel.add(dirP.setMag(force));
  planet.vel.add(
    p5.Vector.sub(projectile.pos, planet.pos).setMag(force / planet.mass)
  );

  projectile.vel.mult(damping);
  planet.vel.mult(damping);
}

function updateBodies() {
  projectile.pos.add(projectile.vel);
  planet.pos.add(planet.vel);
}

function drawBodies() {
  noStroke();

  // planète
  fill(120,120,255);
  ellipse(planet.pos.x, planet.pos.y, planet.r*2);

  // projectile
  fill(255,120,120);
  ellipse(projectile.pos.x, projectile.pos.y, projectile.r*2);
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  resetSim();
}
</script>

</body>
</html>

