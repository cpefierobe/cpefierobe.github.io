<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Gravitation</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body { margin:0; padding:0; overflow:hidden; touch-action:none; }

    /* UI plus adaptée mobile */
    #ui {
  position: static;
  margin: 10px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  font-family: sans-serif;
  color: white;
  font-size: 22px;
  background: rgba(0,0,0,0.4);
  border-radius: 12px;
  z-index: 10;
}
    input[type="range"] {
      width:100%; height:36px;
    }
    button {
      padding:14px 20px;
      font-size:22px;
      border-radius:12px;
      border:none;
      background:#2a66ff;
      color:white;
      font-weight:bold;
    }

    /* Messages centraux */
    #endMessage, #startMessage, #loseMessage {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 32px;
      font-weight: bold;
      text-shadow: 0 0 10px black;
      display: none;
      max-width: 90%;
      text-align:center;
    }
  </style>
</head>

<body>

<div id="ui">
    Planetenmasse :
    <input type="range" min="50" max="10000" value="1500" id="mass">
    <button id="startBtn">Starten</button>
    <button id="resetBtn">Zurücksetzen</button>
</div>

<div id="startMessage">Benutze die Gravitation!</div>

<div id="endMessage" style="text-align: center;">
    <p>Bravo Morty!<br/>
    Um meinen zweiten Brief zu entschlüsseln, brauchst du 3 Farbintensitäten:<br/>
     - Rot R,<br/> 
     - Grün G,<br/>
     - Blau B.<br/>
    G und B sind so, dass
    \[
    G + B = 156 \qquad
    \text{ und }
    \qquad G - B = 110.
    \]
    </p>
</div>

<div id="loseMessage">Verloren!</div>

<script>
let projectile, planet, target;
let launched = false;
let gameOver = false;

// Baisse du G et du damping pour appareils faibles
let G = 0.7;
let softening = 80;  // augmente pour éviter calculs instables
let damping = 0.997; // léger amortissement

// Limite FPS pour économies de CPU
function setup() {
  createCanvas(windowWidth, windowHeight);
  frameRate(45);
  resetSim();

  document.getElementById("startBtn").onclick = () => {
    if (gameOver) return;
    launched = true;
    document.getElementById("startMessage").style.display = "none";
  };

  document.getElementById("resetBtn").onclick = resetSim;
}

function resetSim() {
  launched = false;
  gameOver = false;

  document.getElementById("endMessage").style.display = "none";
  document.getElementById("loseMessage").style.display = "none";
  document.getElementById("startMessage").style.display = "block";

  projectile = {
    pos: createVector(width*0.1, height*0.65),
    vel: createVector(7, -0.93333), // plus lent pour éviter calculs lourds
    mass: 1,
    r: 12
  };

  let m = parseFloat(document.getElementById("mass").value);
  planet = {
    pos: createVector(width*0.5, height*0.5),
    vel: createVector(0, 0),
    mass: m,
    r: map(m, 50, 10000, 30, 110)
  };

  target = createVector(width*0.85, height*0.25);
}

function draw() {
  background(10);

  if (gameOver) {
    drawBodies();
    drawTarget();
    return;
  }

  if (!launched) {
    planet.mass = parseFloat(document.getElementById("mass").value);
    planet.r = map(planet.mass, 50, 10000, 30, 110);
  }

  drawTarget();

  if (launched) applyGravity();
  if (launched) updateBodies();

  if (projectile.pos.dist(planet.pos) < projectile.r + planet.r) {
    launched = false;
    gameOver = true;
    document.getElementById("loseMessage").style.display = "block";
  }

  drawBodies();

  if (!gameOver && launched && projectile.pos.dist(target) < 25) {
    launched = false;
    document.getElementById("endMessage").style.display = "block";
  }
}

// Version simplifiée du calcul gravitationnel pour améliorer fluidité mobile
function applyGravity() {
  let dx = planet.pos.x - projectile.pos.x;
  let dy = planet.pos.y - projectile.pos.y;
  let distSq = dx*dx + dy*dy + softening;

  let force = (G * planet.mass * projectile.mass) / distSq;
  let invDist = 1 / Math.sqrt(distSq);

  projectile.vel.x += dx * invDist * force;
  projectile.vel.y += dy * invDist * force;

  planet.vel.x -= dx * invDist * (force / planet.mass);
  planet.vel.y -= dy * invDist * (force / planet.mass);

  projectile.vel.mult(damping);
  planet.vel.mult(damping);
}

function updateBodies() {
  projectile.pos.add(projectile.vel);
  planet.pos.add(planet.vel);
}

function drawBodies() {
  noStroke();

  fill(120,120,255);
  ellipse(planet.pos.x, planet.pos.y, planet.r*2);

  fill(255,120,120);
  ellipse(projectile.pos.x, projectile.pos.y, projectile.r*2);
}

function drawTarget() {
  stroke(0,255,0); strokeWeight(4); noFill();
  ellipse(target.x, target.y, 50);

  noStroke(); fill(255); textAlign(CENTER, CENTER);
  textSize(26);
  text("Ziel", target.x, target.y - 40);
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  resetSim();
}
</script>

</body>
</html>

